<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>H10 ECG V5.9</title>
    <style>
        body { background-color: #000; color: #0f0; font-family: 'Consolas', monospace; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { background: #051005; padding: 10px 20px; border-bottom: 2px solid #0f0; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        button { background: #003300; color: #0f0; border: 1px solid #0f0; padding: 5px 10px; cursor: pointer; font-weight: bold; font-family: inherit; transition: 0.2s; font-size: 0.8rem; }
        button:hover { background: #0f0; color: #000; box-shadow: 0 0 10px #0f0; }
        button:disabled { background: #222; color: #555; border-color: #444; box-shadow: none; }
        #container { flex: 1; display: flex; position: relative; }
        #chart-area { flex: 1; position: relative; background: linear-gradient(rgba(0, 50, 0, 0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 50, 0, 0.2) 1px, transparent 1px); background-size: 50px 50px; }
        canvas { display: block; width: 100%; height: 100%; }
        #sidebar { width: 320px; background: #020502; border-left: 2px solid #0f0; padding: 15px; display: flex; flex-direction: column; gap: 15px; z-index: 10; overflow-y: auto; }
        .panel { border: 1px solid #0a0; padding: 10px; text-align: center; background: #001100; }
        
        .bpm-row { position: relative; display: flex; justify-content: center; align-items: center; height: 60px; margin: 5px 0; gap: 15px; }
        .val-big { font-size: 3.5rem; font-weight: bold; text-shadow: 0 0 10px #0f0; line-height: 1; z-index: 1; position: relative; }
        #beatCanvas { width: 30px; height: 30px; display: block; }

        .label { font-size: 0.7rem; color: #0a0; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.75rem; color: #8f8; margin-top: 3px; border-bottom: 1px solid #030; padding-bottom: 2px; }
        .control-row { display: flex; justify-content: space-between; gap: 5px; align-items: center; margin-top: 5px; background: #002200; padding: 5px; border-radius: 4px; }
        .control-val { font-weight: bold; color: #fff; min-width: 50px; text-align: right; }
        
        .toggle-btn { width: 100%; padding: 5px; font-size: 0.8rem; margin-top: 5px; }
        .toggle-on { background: #0f0; color: #000; }
        .toggle-off { background: #300; color: #888; border-color: #500; }
    </style>
</head>
<body>

<header>
    <div>âš¡ H10 ECG V5.9</div>
    <div id="status">DISCONNECTED</div>
    <button id="btnConnect" style="padding: 8px 16px;">CONNECT H10</button>
</header>

<div id="container">
    <div id="chart-area">
        <canvas id="ecgCanvas"></canvas>
    </div>
    
    <div id="sidebar">
        <div class="panel">
            <div class="label">HEART RATE</div>
            <div class="bpm-row">
                <div id="hrVal" class="val-big">--</div>
                <canvas id="beatCanvas" width="60" height="60"></canvas>
            </div>
            <div class="label">BPM</div>
        </div>
        
        <div class="panel">
            <div class="label">TUNING: TARGET LATENCY</div>
            <div class="control-row">
                <button onclick="adjTarget(-10)">-10ms</button>
                <span id="dispTarget" class="control-val">50 ms</span>
                <button onclick="adjTarget(10)">+10ms</button>
            </div>
            <div style="font-size: 0.6rem; color: #666; margin-top:2px;">(Lower=Fast, Higher=Smooth)</div>
        </div>

        <div class="panel">
            <div class="label">TUNING: SERVO FORCE (GAIN)</div>
            <div class="control-row">
                <button onclick="adjForce(-0.005)">-0.005</button>
                <span id="dispForce" class="control-val">0.010</span>
                <button onclick="adjForce(0.005)">+0.005</button>
            </div>
            <div style="font-size: 0.6rem; color: #666; margin-top:2px;">(Lower=Gentle, Higher=Aggressive)</div>
        </div>

        <div class="panel">
            <div class="label">ZOOM (Y-AXIS)</div>
            <div class="control-row">
                <button onclick="adjGain(-1)">ZOOM OUT</button>
                <span id="gainVal" class="control-val">1.0x</span>
                <button onclick="adjGain(1)">ZOOM IN</button>
            </div>
        </div>
        
        <div class="panel">
            <div class="label">AUDIO</div>
            <button id="btnSound" class="toggle-btn toggle-on" onclick="toggleSound()">SOUND: ON</button>
        </div>

        <div class="panel">
            <div class="label">SYSTEM STATUS</div>
            <div class="stat-row"><span>PLAYBACK:</span> <span id="actSpd" style="color:yellow">-- Hz</span></div>
            <div class="stat-row"><span>BUFFER:</span> <span id="bufStat">0 ms</span></div>
            <div style="width: 100%; height: 6px; background: #333; margin-top: 5px;">
                <div id="bufBar" style="width: 50%; height: 100%; background: #0f0; transition: width 0.1s;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const SVC_PMD = "fb005c80-02e7-f387-1cad-8acd2d8df0c8";
    const CHR_CP  = "fb005c81-02e7-f387-1cad-8acd2d8df0c8";
    const CHR_DATA= "fb005c82-02e7-f387-1cad-8acd2d8df0c8";
    const SVC_HR  = "0000180d-0000-1000-8000-00805f9b34fb";
    const CHR_HR  = "00002a37-0000-1000-8000-00805f9b34fb";

    const canvas = document.getElementById('ecgCanvas');
    const ctx = canvas.getContext('2d');
    const beatCanvas = document.getElementById('beatCanvas');
    const beatCtx = beatCanvas.getContext('2d');

    let queue = [];
    const H10_RATE = 130;       
    let screenBuffer = []; 
    let screenCursor = 0;
    let lastFrameTime = 0;
    let timeAccumulator = 0;
    let currentPlaybackRate = H10_RATE; 
    let prevRaw = 0, prevFiltered = 0;
    let dcOffset = 0;
    let gainDivisor = 300;
    let gainMult = 1.0;
    
    // --- UPDATED DEFAULTS ---
    let TARGET_LATENCY = 50;   // Hardcore Low Latency
    let SERVO_GAIN = 0.01;     // Very Gentle Tuning

    let beatIntensity = 0.0; 
    const BEAT_DECAY = 0.05; 
    let audioCtx = null;
    let soundEnabled = true;

    // --- UPDATED TUNING FUNCTIONS ---
    window.adjTarget = (delta) => {
        TARGET_LATENCY += delta;
        if (TARGET_LATENCY < 10) TARGET_LATENCY = 10; // Allow super low
        if (TARGET_LATENCY > 2000) TARGET_LATENCY = 2000;
        document.getElementById('dispTarget').innerText = TARGET_LATENCY + " ms";
    };

    window.adjForce = (delta) => {
        SERVO_GAIN += delta;
        if (SERVO_GAIN < 0.001) SERVO_GAIN = 0.001;
        if (SERVO_GAIN > 1.0) SERVO_GAIN = 1.0;
        document.getElementById('dispForce').innerText = SERVO_GAIN.toFixed(3);
    };

    window.adjGain = (dir) => {
        if (dir > 0) { gainDivisor /= 1.25; gainMult *= 1.25; }
        else { gainDivisor /= 0.8; gainMult *= 0.8; }
        document.getElementById('gainVal').innerText = gainMult.toFixed(2) + "x";
    };

    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playBeep() {
        if (!soundEnabled || !audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); 
        gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15); 
        osc.start();
        osc.stop(audioCtx.currentTime + 0.15);
    }

    window.toggleSound = () => {
        soundEnabled = !soundEnabled;
        const btn = document.getElementById('btnSound');
        if (soundEnabled) {
            btn.innerText = "SOUND: ON";
            btn.className = "toggle-btn toggle-on";
            if (audioCtx) playBeep();
        } else {
            btn.innerText = "SOUND: MUTE";
            btn.className = "toggle-btn toggle-off";
        }
    };

    function resize() {
        const p = canvas.parentElement;
        canvas.width = p.clientWidth;
        canvas.height = p.clientHeight;
        if (screenBuffer.length !== canvas.width) {
            screenBuffer = new Float32Array(canvas.width).fill(canvas.height / 2);
            screenCursor = 0;
        }
    }
    window.onresize = resize;
    resize();

    function drawHeart() {
        beatCtx.clearRect(0, 0, beatCanvas.width, beatCanvas.height);
        const w = beatCanvas.width;
        const h = beatCanvas.height;
        const scale = 1.0; 
        
        beatCtx.save();
        beatCtx.translate(w/2, h/2);
        beatCtx.scale(scale, scale);
        
        beatCtx.beginPath();
        beatCtx.moveTo(0, -10);
        beatCtx.bezierCurveTo(-25, -30, -50, -10, 0, 32); 
        beatCtx.bezierCurveTo(50, -10, 25, -30, 0, -10);
        beatCtx.closePath();

        const r = Math.floor(50 + (205 * beatIntensity));
        beatCtx.fillStyle = `rgb(${r}, 0, 0)`;
        beatCtx.shadowBlur = 0; 
        beatCtx.fill();
        beatCtx.restore();
    }

    function loop(timestamp) {
        if (!lastFrameTime) lastFrameTime = timestamp;
        const dt = (timestamp - lastFrameTime) / 1000; 
        lastFrameTime = timestamp;

        beatIntensity -= BEAT_DECAY;
        if (beatIntensity < 0) beatIntensity = 0;
        drawHeart();

        // --- TUNABLE SERVO LOGIC ---
        const bufferMs = (queue.length / H10_RATE) * 1000;
        const error = bufferMs - TARGET_LATENCY;
        
        // Use the manual Gain and Target
        let targetRate = H10_RATE + (error * SERVO_GAIN); 
        
        if (targetRate < 80) targetRate = 80;
        if (targetRate > 200) targetRate = 200;
        
        currentPlaybackRate = (currentPlaybackRate * 0.95) + (targetRate * 0.05);

        document.getElementById('actSpd').innerText = currentPlaybackRate.toFixed(1) + " Hz";
        document.getElementById('bufStat').innerText = bufferMs.toFixed(0) + " ms";
        
        const barW = Math.min((bufferMs / 500) * 100, 100);
        document.getElementById('bufBar').style.width = barW + "%";
        // Critical Red Zone reduced to 5ms since we target 50ms
        document.getElementById('bufBar').style.background = (barW < 2) ? 'red' : '#0f0';

        timeAccumulator += dt;
        const step = 1 / currentPlaybackRate;
        while (timeAccumulator >= step) {
            timeAccumulator -= step;
            if (queue.length > 0) {
                const val = queue.shift(); 
                dcOffset = (dcOffset * 0.995) + (val * 0.005);
                const centered = val - dcOffset;
                const y = (canvas.height / 2) - (centered / gainDivisor);
                screenBuffer[screenCursor] = y;
                screenCursor++;
                if (screenCursor >= canvas.width) screenCursor = 0;
            }
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#002200'; ctx.lineWidth = 1; ctx.beginPath();
        for(let x=0;x<canvas.width;x+=50){ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);}
        ctx.stroke();

        ctx.lineWidth = 2; ctx.strokeStyle = '#0f0'; ctx.shadowBlur = 0; ctx.beginPath();
        let isDrawing = false;
        for (let i = 0; i < screenBuffer.length; i++) {
            const dist = Math.abs(i - screenCursor);
            if (dist < 15) { isDrawing = false; continue; }
            if (!isDrawing) { ctx.moveTo(i, screenBuffer[i]); isDrawing = true; } 
            else { ctx.lineTo(i, screenBuffer[i]); }
        }
        ctx.stroke();

        ctx.fillStyle = '#002200'; ctx.fillRect(screenCursor, 0, 2, canvas.height);
        ctx.shadowBlur = 0;

        requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    document.getElementById('btnConnect').onclick = async () => {
        try {
            initAudio();
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: "Polar H10" }],
                optionalServices: [SVC_PMD, SVC_HR]
            });
            const server = await device.gatt.connect();
            document.getElementById('status').innerText = "ONLINE";
            document.getElementById('btnConnect').disabled = true;

            const hrSvc = await server.getPrimaryService(SVC_HR);
            const hrCh = await hrSvc.getCharacteristic(CHR_HR);
            await hrCh.startNotifications();
            hrCh.addEventListener('characteristicvaluechanged', e => {
                document.getElementById('hrVal').innerText = e.target.value.getUint8(1);
                beatIntensity = 1.0; 
                playBeep();
            });

            const pmdSvc = await server.getPrimaryService(SVC_PMD);
            const cpCh = await pmdSvc.getCharacteristic(CHR_CP);
            const dataCh = await pmdSvc.getCharacteristic(CHR_DATA);

            await cpCh.startNotifications();
            await cpCh.writeValue(new Uint8Array([0x02, 0x00, 0x00, 0x01, 0x82, 0x00, 0x01, 0x01, 0x0E, 0x00]));
            
            await dataCh.startNotifications();
            dataCh.addEventListener('characteristicvaluechanged', e => {
                const val = e.target.value;
                if (val.getUint8(0) !== 0x00) return; 
                for (let i = 10; i < val.byteLength; i += 3) {
                    if (i + 2 >= val.byteLength) break;
                    let sample = val.getUint8(i) | (val.getUint8(i+1) << 8) | (val.getUint8(i+2) << 16);
                    if (sample & 0x800000) sample -= 0x1000000;
                    const alpha = 0.995;
                    let filtered = alpha * (prevFiltered + sample - prevRaw);
                    prevRaw = sample;
                    prevFiltered = filtered;
                    queue.push(filtered);
                }
            });
        } catch (e) {
            console.error(e);
            document.getElementById('btnConnect').disabled = false;
        }
    };
</script>
</body>
</html>